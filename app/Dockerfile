# -------------------------------------------------------------
# Базовый образ Python 3.12 (slim) – Debian‑based
# -------------------------------------------------------------
FROM python:3.12-slim

# -------------------------------------------------------------
# Системные пакеты, необходимые для psycopg2 и отладки
# -------------------------------------------------------------
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        gcc libpq-dev \          # нужен для psycopg2‑binary
        curl \                  # уже нужен в контейнере (health‑check, curl‑test)
        iputils-ping \          # ping
        netcat-openbsd \        # nc (netcat)
        bash \                  # optional – если хотите полноценный bash‑shell
    && rm -rf /var/lib/apt/lists/*

# -------------------------------------------------------------
# Обновляем pip до последней версии (чтобы он корректно обрабатывал manylinux‑wheels)
# -------------------------------------------------------------
RUN pip install --no-cache-dir --upgrade pip

# -------------------------------------------------------------
# Рабочая директория
# -------------------------------------------------------------
WORKDIR /app

# -------------------------------------------------------------
# Кешируем установку python‑зависимостей (быстрее при небольших изменениях)
# -------------------------------------------------------------
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# -------------------------------------------------------------
# Копируем код проекта
# -------------------------------------------------------------
COPY . .

# -------------------------------------------------------------
# Открываем порт (информативно, compose уже делает проброс)
# -------------------------------------------------------------
EXPOSE 5000

# -------------------------------------------------------------
# Запуск Gunicorn, слушаем 0.0.0.0:5000
# -------------------------------------------------------------
CMD ["gunicorn", "app:app", "--bind", "0.0.0.0:5000", "--workers", "2"]
